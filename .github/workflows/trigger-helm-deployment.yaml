name: 'üöÄ Deploy'

on:
  workflow_dispatch:
    inputs:
      app_version:
        description: 'App version to deploy (e.g., 3.49.4 or patch/minor/major)'
        required: true
        default: 'patch'
        type: string
      charts:
        description: 'Charts to update (comma-separated, leave empty for all)'
        required: false
        default: ''
        type: string
      target_repo:
        description: 'Target repository (owner/repo)'
        required: false
        default: 'FmTod2/mylisterhub-cloud-config'
        type: string
      deployment_token:
        description: 'GitHub token with permissions to trigger deployment'
        required: true
        type: string
  workflow_call:
    inputs:
        app_version:
            required: false
            type: string
        charts:
            required: false
            type: string
        target_repo:
            required: false
            type: string
        deployment_token:
            required: true
            type: string

jobs:
  trigger-deployment:
    name: 'Trigger Deployment'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract version information
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          # Extract version from release tag
          VERSION="${{ github.event.release.tag_name }}"
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "trigger_source=release" >> $GITHUB_OUTPUT
          echo "release_name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # Extract version from tag
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "trigger_source=tag" >> $GITHUB_OUTPUT
        else
          # Manual workflow dispatch
          echo "app_version=${{ github.event.inputs.app_version }}" >> $GITHUB_OUTPUT
          echo "trigger_source=manual" >> $GITHUB_OUTPUT
        fi

    - name: Set deployment parameters
      id: params
      run: |
        APP_VERSION="${{ steps.version.outputs.app_version }}"

        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          CHARTS="${{ github.event.inputs.charts }}"
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
        else
          CHARTS=""  # Deploy all charts for automated triggers
          TARGET_REPO="FmTod2/mylisterhub-cloud-config"
        fi

        echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
        echo "charts=$CHARTS" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT

        echo "Will trigger deployment with:"
        echo "  - App Version: $APP_VERSION"
        echo "  - Charts: ${CHARTS:-'all'}"
        echo "  - Target Repo: $TARGET_REPO"
        echo "  - Trigger Source: ${{ steps.version.outputs.trigger_source }}"

    - name: Trigger production deployment
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ inputs.deployment_token }}
        repository: ${{ steps.params.outputs.target_repo }}
        event-type: deploy-production
        client-payload: |
          {
            "app_version": "${{ steps.params.outputs.app_version }}",
            "charts": "${{ steps.params.outputs.charts }}",
            "source_repo": "${{ github.repository }}",
            "source_ref": "${{ github.ref }}",
            "source_sha": "${{ github.sha }}",
            "trigger_source": "${{ steps.version.outputs.trigger_source }}",
            "triggered_by": "${{ github.actor }}"
          }

    - name: Create deployment summary
      run: |
        echo "## Production Deployment Triggered" >> $GITHUB_STEP_SUMMARY
        echo "- **App Version**: ${{ steps.params.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Charts**: ${{ steps.params.outputs.charts || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Repository**: ${{ steps.params.outputs.target_repo }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger Source**: ${{ steps.version.outputs.trigger_source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The deployment workflow has been triggered in the cloud configuration repository." >> $GITHUB_STEP_SUMMARY
        echo "Monitor the deployment progress at: https://github.com/${{ steps.params.outputs.target_repo }}/actions" >> $GITHUB_STEP_SUMMARY

    - name: Notify deployment trigger failure
      if: failure()
      run: |
        echo "‚ùå Failed to trigger production deployment"
        echo "Repository: ${{ github.repository }}"
        echo "Event: ${{ github.event_name }}"
        echo "Actor: ${{ github.actor }}"
        echo "Ref: ${{ github.ref }}"

        # You can add additional notification logic here
        # such as sending to Slack, Discord, email, etc.
